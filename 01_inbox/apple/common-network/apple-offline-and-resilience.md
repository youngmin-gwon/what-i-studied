# Offline & Resilience Patterns #apple #network #offline #common

네트워크가 없거나 불안정할 때도 앱이 안전하게 동작하도록 만드는 쉬운 가이드. 용어는 [[apple-glossary]].

## 왜 필요한가?
- 사용자는 지하철/비행기/시골 등 오프라인 상황을 자주 겪는다.
- 서버/네트워크 오류가 나도 데이터가 날아가면 안 된다.
- 배터리/데이터를 아끼면서도 부드러운 경험을 유지해야 한다.

## 기본 전략
1) 로컬 우선: 가능하면 로컬 캐시/DB를 먼저 보여주고, 동기화는 뒤에서.
2) 실패 친화: 네트워크 에러는 정상적인 경우로 취급하고 UI/데이터 구조를 이에 맞춘다.
3) 충돌 대비: 여러 기기/사용자가 동시에 수정할 때 규칙을 정해둔다.

## 로컬 저장
- Core Data/SQLite/Realm 등을 사용해 주요 데이터를 저장.
- 디바이스에 저장해도 프라이버시/암호화(Data Protection, Keychain) 고려.
- 캐시와 영구 데이터 구분: Caches vs Application Support.

## 동기화 큐(Outbox)
- 보낼 일을 큐에 적고, 네트워크가 될 때 묶어서 전송.
- 각 작업에 고유 ID/버전/타임스탬프를 둬서 중복/충돌 방지.
- 재시도/백오프/최대 시도 수 설정.

## 병합/충돌 정책
- 마지막 작성자 우선(LWW), 필드 단위 병합, 수동 병합 등 앱 성격에 맞게 선택.
- 사용자에게 충돌 해결 UI를 제공하거나, 서버 규칙으로 자동 선택.

## 오프라인 UX
- 상태 표시: 오프라인/저품질 모드 배지, 최근 동기화 시간.
- 입력/편집 허용: 저장 후 나중에 업로드. 버튼 라벨/토스트로 안내.
- 요청 실패 시 재시도 버튼 제공, 자동 재시도 중인지 알려주기.

## 미디어/대용량
- 업로드: 백그라운드 세션 + 재개 토큰. 네트워크가 없으면 로컬에 잠시 저장.
- 다운로드: 품질 낮추기/지연하기. HLS는 자동 적응하지만 시작 비트레이트를 조정할 수 있다.

## 네트워크 상태 감지
- NWPathMonitor/Reachability로 상태 구독. 단, “연결됨”이라도 실제 요청이 실패할 수 있음을 고려.
- Low Data/Low Power 모드 시 자동으로 경량 동작.

## 테스트 시나리오
- 완전 오프라인, 간헐 연결, 높은 지연, 패킷 손실, 플라이트 모드.
- 서버 오류(429/500), 인증 만료, 토큰 재발급 실패.
- 앱 강제 종료/재시작 중에도 큐/캐시가 유지되는지 확인.

## 보안/프라이버시
- 로컬 캐시에 민감 정보가 있다면 암호화/만료/삭제 정책을 둔다.
- 동기화 요청에는 최소 데이터만 포함, 토큰은 Keychain에서 필요할 때만 읽기.

## 모니터링
- 실패율/재시도 횟수/오프라인 편집 건수/동기화 지연을 기록.
- 배터리/데이터 사용량을 추적, 너무 크면 전략 조정.

## 링크
[[apple-cloud-sync-patterns]], [[apple-network-basics]], [[apple-network-debug-and-recipes]], [[apple-storage-and-filesystems]], [[apple-sandbox-and-security]].
